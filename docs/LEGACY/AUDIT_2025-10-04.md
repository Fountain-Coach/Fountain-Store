# Implementation Audit — 2025-10-04

This audit summarizes the current implementation and tests vs. the project’s promises. It highlights delivered functionality, known gaps, and recommended next steps before tagging a release.

## Core Engine

- WAL + Recovery
  - CRC32 per-record, fsync boundaries; segmented WAL with GC; replay filters partial/corrupt frames.
  - Refs: Sources/FountainStoreCore/WAL.swift, Sources/FountainStore/Store.swift:308, 515

- Persistent MVCC
  - Sequence numbers embedded in SSTable keys; preserved across restart.
  - Refs: Sources/FountainStore/Store.swift:458, 493

- Memtable + SSTables
  - Memtable with flush; SSTables with block index, per-block CRC, persisted Bloom filter.
  - Refs: Sources/FountainStoreCore/SSTable.swift

- Compaction
  - Coarse “merge overlapping” tick; status: virtual levels, debt, pending tables.
  - Refs: Sources/FountainStoreCore/Compactor.swift

- Caching
  - Block cache configurable via `StoreOptions.cacheBytes`.
  - Refs: Sources/FountainStore/Store.swift:306

## Indexes & Queries

- Typed indexes
  - unique, multi, FTS, vector; equality and prefix scans.
  - Refs: Sources/FountainStore/Store.swift:933, 1114, 1171

- Index definition persistence
  - Manifest persists name/kind/(optional) field.
  - Refs: Sources/FountainStore/Store.swift:597
  - Gap: Auto rebuild of typed indexes on open not implemented; tests re-define after reopen.

- Dynamic HTTP indexes
  - `multi` backed by JSON path extractor; definitions persisted with keyPath; rebuilt on server startup.
  - Refs: Sources/FountainStoreHTTP/AdminService.swift:74, 90; Sources/FountainStoreHTTPServer/main.swift
  - Gap: dynamic `unique` not enforced (persisted as requested, backed by `multi`).

## Transactions

- Atomic batch with BEGIN/OP/COMMIT, sequence guard.
- Refs: Sources/FountainStore/Store.swift:60, 1006; tests cover atomicity & guards.

## Backups & Restore

- list/create/restore with manifest rewrite and WAL handling; HTTP endpoints for list/create/restore (202 Accepted).
- Refs: Sources/FountainStore/Store.swift:1218; Sources/FountainStoreHTTPServer/main.swift:267

## Observability & Tuning

- Metrics counters; structured logs; configurable defaults.
- Refs: Sources/FountainStore/Store.swift:127, 410

## Optional Modules

- FTS (BM25 + custom analyzers), Vector (HNSW; cosine/L2); unit tests present.

## HTTP Surface & OpenAPI

- Endpoints: health, status (with compaction), metrics; collections CRUD; indexes list/define; records CRUD (201/200 + Location); queries (byId/indexEquals/scan) with pagination; transactions; snapshots; backups; compaction status/run.
- Pagination across lists and queries; RFC7807 errors; strict id consistency on PUT; 404 delete missing; optional API key auth via `FS_API_KEY`.
- OpenAPI examples updated.

## Gaps vs. Promise

- Index rebuild on open (typed): missing; dynamic (HTTP) implemented.
- Dynamic unique enforcement: not implemented; uses `multi` fallback.
- HTTP security: API key/Bearer optional guard added; no advanced auth.
- Compaction sophistication: no leveled/throttled compaction.
- Pagination tokens: simple/stable (non-opaque).

## Tests

- Engine: puts/gets/deletes, snapshots, history, unique/multi, prefix scans, persistence (with manual redefine), WAL corruption property, manifest monotonicity, compaction status.
- HTTP E2E: health; collections CRUD & errors; indexes define/list 404/409; record PUT 201/200; id mismatch 400; delete 404; query pagination; snapshots; transactions (conflict shape); compaction run/status; backups list/create/restore.

## Release Readiness & Recommendations

- Recommend 0.2.0-beta tag with clear notes:
  - Stable: engine core (WAL/manifest/MVCC), typed indexes, transactions, backups, HTTP subset with pagination & record metadata.
  - Limitations: HTTP auth optional; dynamic unique not enforced; typed index rebuild on open not implemented; compaction not leveled; simple page tokens.

## Next Steps (PX)

- P1
  - Auto index rebuild on open (typed): persist field where possible; rebuild maps at open.
  - Dynamic unique enforcement for HTTPDoc.
  - Harden HTTP auth (API key/Bearer, 401/403 paths).

- P2
  - Compaction: leveled + throttling; integrate backpressure.
  - Stress tests: WAL rotation under load; compaction while writing; large scans; backup under traffic.
  - Pagination: move to opaque, signed cursors.

- P3
  - Observability: latency histograms; Prometheus exposition.
  - Docs: deployment/security guidance.

